<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Säule 3a Szenario Rechner</title>
    
    <!-- Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js --><script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Konfiguriert Tailwind, um die Schriftart 'Inter' zu verwenden
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    
    <!-- Druck-Stile für PDF-Export --><style>
        @media print {
            /* KORRIGIERT: Nur Elemente mit .no-print ausblenden */
            .no-print {
                display: none !important;
            }
            
            /* Sicherstellen, dass der Export-Bereich den ganzen Platz einnimmt */
            .print-container,
            .print-container .print-content {
                display: block !important;
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
                background: #ffffff !important; /* Heller Hintergrund für Druck */
                color: #000000 !important; /* Schwarzer Text für Druck */
            }

            /* Spezifische Anpassungen für den Druck */
            h1, h2, h3, p, span, div {
                color: #000000 !important;
            }
            
            /* KORREKTUR: Stabile Höhe für den Druck (verhindert Verschwinden/Verzerren) */
            .print-content .chart-container { /* Geändert von bg-gray-700 zu einer dedizierten Klasse */
                width: 100% !important;
                height: 10cm !important; /* Feste, stabile Höhe für den Druck */
                padding: 0 !important;
                border: none !important;
                background: #ffffff !important; 
                overflow: hidden; /* Verhindert seltsame Überläufe */
            }

            .print-content canvas {
                /* Canvas soll den Container füllen */
                position: static !important; /* WICHTIG: Positionierung zurücksetzen */
                width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
            }
            
            /* Seitenlayout im Querformat vorschlagen */
            @page {
                size: landscape;
                margin: 2cm;
            }
        }
    </style>
</head>
<body class="bg-gray-900 font-sans antialiased text-gray-200">

    <div class="container mx-auto max-w-full p-4 sm:p-6 lg:p-8">
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Linke Spalte: Formular (wird bei Druck ausgeblendet) --><div class="lg:col-span-1 space-y-6 no-print">
                
                <h1 class="text-2xl sm:text-3xl font-bold text-blue-400 mb-4">
                    Säule 3a Szenario Rechner
                </h1>
                <!-- NEU: Untertitel mit Namen -->
                <p class="text-gray-400 text-sm -mt-4 mb-6">Von: Simon, Marc und Arian</p>

                <p class="text-gray-300 mb-6">
                    Fügen Sie ein oder mehrere Szenarien hinzu, um deren Entwicklung von 18 bis 65 Jahren zu vergleichen.
                </p>

                <!-- Formular für Szenarien --><form id="scenario-form" class="bg-gray-800 p-6 rounded-lg border border-gray-700 space-y-4">
                    <h2 id="form-title" class="text-lg font-semibold text-blue-300 mb-3">Neues Szenario Hinzufügen</h2>
                    
                    <!-- Verstecktes Feld zur Speicherung des Bearbeitungs-Index --><input type="hidden" id="edit-index" value="-1">

                    <div>
                        <label for="scenario-name" class="block text-sm font-medium text-gray-300">Szenario-Name</label>
                        <input type="text" id="scenario-name" placeholder="z.B. Konservativ" class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" required>
                    </div>

                    <div>
                        <label for="anlage-typ" class="block text-sm font-medium text-gray-300">Anlage-Typ (z.B. Aktienfonds)</label>
                        <input type="text" id="anlage-typ" placeholder="z.B. Aktienfonds, Sparkonto" class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                    </div>

                    <div>
                        <label for="beitrag-typ" class="block text-sm font-medium text-gray-300">Beitrags-Typ</label>
                        <!-- ÄNDERUNG HIER: "selected" bei "max-mit-pk" -->
                        <select id="beitrag-typ" class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            <option value="manuell">Manueller Jahresbeitrag</option>
                            <option value="max-mit-pk" selected>Max. mit PK (CHF 7'258 / Jahr)</option>
                            <option value="max-ohne-pk">Max. ohne PK (CHF 36'288 / Jahr)</option>
                        </select>
                    </div>

                    <div id="prozent-beitrag-container" class="hidden">
                        <label for="prozent-beitrag" class="block text-sm font-medium text-gray-300">Prozentsatz des Beitrags (%)</label>
                        <input type="number" id="prozent-beitrag" value="100" step="1" class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                    </div>

                    <div id="manuell-beitrag-container">
                        <label for="jahresbeitrag" class="block text-sm font-medium text-gray-300">Jährlicher Beitrag (CHF)</label>
                        <input type="number" id="jahresbeitrag" value="6000" class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                    </div>
                    
                    <div>
                        <label for="beitrag-steigerung" class="block text-sm font-medium text-gray-300">Jähliche Beitragssteigerung (%)</label>
                        <input type="number" id="beitrag-steigerung" value="0" step="0.1" class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                    </div>

                    <div>
                        <label for="rendite" class="block text-sm font-medium text-gray-300">Jähliche Rendite (%)</label>
                        <input type="number" id="rendite" value="5" step="0.1" class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                    </div>
                    
                    <!-- NEUE GEBÜHRENFELDER -->
                    <div class="border-t border-gray-700 pt-4">
                        <h3 class="text-md font-semibold text-blue-300 mb-2">Gebühren (Optional)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="depot-gebuehr" class="block text-sm font-medium text-gray-300">Depotgebühr (% p.a.)</label>
                                <input type="number" id="depot-gebuehr" value="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="verwaltungs-gebuehr" class="block text-sm font-medium text-gray-300">Verwaltung (% p.a.)</label>
                                <input type="number" id="verwaltungs-gebuehr" value="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="broker-courtage" class="block text-sm font-medium text-gray-300">Courtage (% d. Einz.)</label>
                                <input type="number" id="broker-courtage" value="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                        </div>
                    </div>
                    <!-- ENDE NEUE GEBÜHRENFELDER -->

                    <!-- Einzahlungs-Periode (Geändert) -->
                    <div class="border-t border-gray-700 pt-4">
                        <h3 class="text-md font-semibold text-blue-300 mb-2">Einzahlungsperiode</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="einzahlung-start" class="block text-sm font-medium text-gray-300">Start-Alter (Default: 18)</label>
                                <input type="number" id="einzahlung-start" value="18" min="18" max="65" class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="einzahlung-ende" class="block text-sm font-medium text-gray-300">End-Alter (Default: 65)</label>
                                <input type="number" id="einzahlung-ende" value="65" min="18" max="65" class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- NEU: Optionale Einzahlungspause -->
                    <div class="border-t border-gray-700 pt-4">
                        <h3 class="text-md font-semibold text-blue-300 mb-2">Optionale Einzahlungspause</h3>
                        <p class="text-sm text-gray-400 mb-2">Setzen Sie Start/Ende auf 0, um keine Pause zu haben.</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="pause-start" class="block text-sm font-medium text-gray-300">Pause Start-Alter</label>
                                <input type="number" id="pause-start" value="0" min="0" max="65" class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="pause-ende" class="block text-sm font-medium text-gray-300">Pause End-Alter</label>
                                <input type="number" id="pause-ende" value="0" min="0" max="65" class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                        </div>
                    </div>
                    <!-- ENDE NEUE SEKTION -->
                    
                    <!-- Bezugs-Alter pro Szenario --><div>
                        <label for="bezug-alter-szenario" class="block text-sm font-medium text-gray-300">Bezugs-Alter (Simulation stoppt)</label>
                        <input type="number" id="bezug-alter-szenario" value="65" min="19" max="65" class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                    </div>

                    <button type="submit" id="submit-button" class="w-full justify-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600">
                        Szenario Hinzufügen
                    </button>
                    <button type="button" id="cancel-edit-button" class="hidden w-full justify-center rounded-md bg-gray-500 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-400 mt-2">
                        Bearbeiten abbrechen
                    </button>
                </form>
            </div>

            <!-- Rechte Spalte: Grafik und Tabelle (wird gedruckt) --><div class="lg:col-span-2 print-container">
                <div class="bg-gray-800 rounded-lg shadow-xl p-6 sm:p-8 print-content">
                    
                    <!-- Aktive Szenarien --><div class="mb-4">
                        <h3 class="text-md font-semibold text-gray-300 mb-2">Aktive Szenarien:</h3>
                        <div id="scenario-list" class="flex flex-wrap gap-2">
                            <!-- Szenario-Tags werden hier dynamisch eingefügt --></div>
                    </div>

                    <!-- Grafik --><div class="bg-gray-700 p-4 rounded-lg border border-gray-600 h-[300px] sm:h-[400px] lg:h-[500px] w-full mb-6 chart-container">
                        <canvas id="comparison-chart"></canvas>
                    </div>

                    <!-- Zusammenfassungstabelle --><div class="overflow-x-auto">
                        <div class="flex justify-between items-center mb-2 flex-wrap gap-2">
                            <!-- Titel -->
                            <h3 id="summary-title" class="text-md font-semibold text-gray-300">
                                Zusammenfassung (End-Alter 65)
                            </h3>
                            <!-- Inflations-Steuerung -->
                            <div class="flex items-center space-x-2 no-print">
                                <label for="inflation" class="text-sm font-medium text-gray-300">Ø Inflation (%/Jahr):</label>
                                <input type="number" id="inflation" value="1.5" step="0.1" class="w-16 rounded-md border-gray-600 bg-gray-700 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-1">
                                <input type="checkbox" id="inflation-bereinigt" class="rounded border-gray-600 bg-gray-700 text-blue-500 focus:ring-blue-500">
                                <label for="inflation-bereinigt" class="text-sm font-medium text-gray-300">Inflationsbereinigt</label>
                            </div>
                        </div>
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-800">
                                <tr>
                                    <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-blue-300 uppercase tracking-wider">Szenario</th>
                                    <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-blue-300 uppercase tracking-wider">Endkapital (mit 65)</th>
                                    <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-blue-300 uppercase tracking-wider">Total Einzahlungen</th>
                                    <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-blue-300 uppercase tracking-wider">Gewinn (Zinsen)</th>
                                    <!-- NEU: Faktor Spaltenkopf -->
                                    <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-blue-300 uppercase tracking-wider">Faktor (x-fach)</th>
                                    <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-blue-300 uppercase tracking-wider">Diff. z. Besten</th>
                                </tr>
                            </thead>
                            <tbody id="summary-table-body" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Tabellenzeilen werden hier dynamisch eingefügt --></tbody>
                        </table>
                    </div>


                    <!-- Buttons für Reset und Export --><div class="flex flex-wrap gap-4 mt-6">
                        <button id="reset-all" class="flex-1 sm:flex-none justify-center rounded-md bg-red-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 no-print">
                            Alle Szenarien löschen
                        </button>
                        <button id="export-pdf" class="flex-1 sm:flex-none justify-center rounded-md bg-green-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 no-print">
                            Als PDF exportieren
                        </button>
                        <!-- NEU: CSV Export Button -->
                        <button id="export-csv" class="flex-1 sm:flex-none justify-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 no-print">
                            Als CSV (Excel) exportieren
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM-Elemente
        const scenarioForm = document.getElementById('scenario-form');
        const scenarioList = document.getElementById('scenario-list');
        const resetBtn = document.getElementById('reset-all');
        const exportPdfBtn = document.getElementById('export-pdf');
        const exportCsvBtn = document.getElementById('export-csv'); 
        const chartCanvas = document.getElementById('comparison-chart').getContext('2d');
        const summaryTableBody = document.getElementById('summary-table-body');
        const summaryTitle = document.getElementById('summary-title');
        
        // Inflations-Elemente
        const inflationInput = document.getElementById('inflation');
        const inflationBereinigtCheckbox = document.getElementById('inflation-bereinigt');

        // Formular-Elemente
        const formTitle = document.getElementById('form-title');
        const editIndexInput = document.getElementById('edit-index');
        const scenarioNameInput = document.getElementById('scenario-name');
        const anlageTypInput = document.getElementById('anlage-typ');
        const beitragTypSelect = document.getElementById('beitrag-typ');
        const prozentBeitragContainer = document.getElementById('prozent-beitrag-container');
        const prozentBeitragInput = document.getElementById('prozent-beitrag');
        const manuellBeitragContainer = document.getElementById('manuell-beitrag-container');
        const jahresbeitragInput = document.getElementById('jahresbeitrag');
        const beitragSteigerungInput = document.getElementById('beitrag-steigerung');
        const renditeInput = document.getElementById('rendite');
        const einzahlungStartInput = document.getElementById('einzahlung-start');
        const einzahlungEndeInput = document.getElementById('einzahlung-ende');
        // NEU: Pausen-Felder
        const pauseStartInput = document.getElementById('pause-start');
        const pauseEndeInput = document.getElementById('pause-ende');
        const bezugAlterSzenarioInput = document.getElementById('bezug-alter-szenario'); 
        const submitButton = document.getElementById('submit-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');

        // NEUE GEBÜHREN-ELEMENTE
        const depotGebuehrInput = document.getElementById('depot-gebuehr');
        const verwaltungsGebuehrInput = document.getElementById('verwaltungs-gebuehr');
        const brokerCourtageInput = document.getElementById('broker-courtage');


        let scenarios = [];
        let chartInstance = null;
        let scenarioCounter = 1; // Zähler für automatische Namen
        
        // Globale Laufzeit (Fix 18-65)
        const START_ALTER = 18;
        const END_ALTER = 65;
        const GESAMT_JAHRE = END_ALTER - START_ALTER; // 47 Jahre

        // Max. Säule 3a Beiträge (Stand 2025)
        const MAX_BEITAG_MIT_PK_JAHR = 7258;
        const MAX_BEITAG_OHNE_PK_JAHR = 36288;

        // Vordefinierte Farben für die Graphen (angepasst für Dark Mode)
        const CHART_COLORS = [
            '#60a5fa', // blue-400
            '#f87171', // red-400
            '#4ade80', // green-400
            '#facc15', // yellow-400
            '#c084fc', // purple-400
            '#fb923c', // orange-400
        ];

        // --- Event Listeners ---

        // Formular für neues Szenario / Aktualisierung
        scenarioForm.addEventListener('submit', (e) => {
            e.preventDefault(); 
            const editIndex = parseInt(editIndexInput.value, 10);
            
            if (editIndex > -1) {
                updateScenario(editIndex); // Aktualisiert ein bestehendes Szenario
            } else {
                addScenario(); // Fügt ein neues Szenario hinzu
            }
        });

        // "Alle löschen"-Button
        resetBtn.addEventListener('click', () => {
            scenarios = [];
            scenarioCounter = 1; // Zähler zurücksetzen
            renderScenarioList();
            resetForm(); 
            updateChartAndTable(); 
        });

        // PDF Export Button
        exportPdfBtn.addEventListener('click', () => {
            window.print(); // Löst den Browser-Druckdialog aus
        });

        // CSV Export Button
        exportCsvBtn.addEventListener('click', exportToCSV);

        // Klick-Handler für die Szenarien-Liste (Löschen oder Bearbeiten)
        scenarioList.addEventListener('click', (e) => {
            const button = e.target.closest('button'); // Klick auf Button finden
            if (!button) return;

            const action = button.dataset.action;
            const index = parseInt(button.dataset.index, 10);

            if (action === 'remove') {
                scenarios.splice(index, 1); 
                renderScenarioList();
                updateChartAndTable();
            } else if (action === 'edit') {
                loadScenarioIntoForm(index);
            }
        });

        // Event listener für Beitrags-Typ-Auswahl (zeigt/verbirgt Felder)
        beitragTypSelect.addEventListener('change', updateBeitragFelder);

        // "Bearbeiten abbrechen"-Button
        cancelEditButton.addEventListener('click', resetForm);
        
        // Inflations-Steuerung löst Neuberechnung aus
        inflationInput.addEventListener('input', updateChartAndTable);
        inflationBereinigtCheckbox.addEventListener('change', updateChartAndTable);

        // --- Hauptfunktionen ---

        /**
         * Fügt ein neues Szenario basierend auf den aktuellen Eingabefeldern hinzu
         */
        function addScenario() {
            const newScenario = readScenarioFromForm();
            scenarios.push(newScenario);
            
            scenarioCounter++; // Zähler für nächstes Szenario erhöhen
            
            renderScenarioList();
            updateChartAndTable();
            resetForm(); // Formular für die nächste Eingabe zurücksetzen
        }

        /**
         * Aktualisiert ein bestehendes Szenario
         */
        function updateScenario(index) {
            const updatedScenario = readScenarioFromForm();
            scenarios[index] = updatedScenario;
            
            renderScenarioList();
            updateChartAndTable();
            resetForm(); // Formular zurücksetzen
        }

        /**
         * Liest alle Daten aus dem Formular und erstellt ein Szenario-Objekt
         */
        function readScenarioFromForm() {
            const beitragTyp = beitragTypSelect.value;
            const prozentSatz = (parseFloat(prozentBeitragInput.value) || 100) / 100;
            let jahresbeitragBasis = 0;
            let beitragText = '';

            if (beitragTyp === 'manuell') {
                jahresbeitragBasis = parseFloat(jahresbeitragInput.value) || 0;
                beitragText = `${jahresbeitragBasis.toFixed(0)} CHF/Jahr`;
            } else if (beitragTyp === 'max-mit-pk') {
                jahresbeitragBasis = MAX_BEITAG_MIT_PK_JAHR * prozentSatz;
                beitragText = `Max. mit PK (${(prozentSatz*100).toFixed(0)}%)`;
            } else if (beitragTyp === 'max-ohne-pk') {
                jahresbeitragBasis = MAX_BEITAG_OHNE_PK_JAHR * prozentSatz;
                beitragText = `Max. ohne PK (${(prozentSatz*100).toFixed(0)}%)`;
            }

            const anlageTyp = anlageTypInput.value.trim() || '';
            const rendite = parseFloat(renditeInput.value) || 0;
            const displayText = `${anlageTyp} (${rendite}%)`;
            
            return {
                name: scenarioNameInput.value.trim(),
                anlageTyp: anlageTyp,
                beitragTyp: beitragTyp,
                prozentBeitrag: prozentSatz * 100,
                jahresbeitragBasis: (beitragTyp === 'manuell') ? jahresbeitragBasis : (jahresbeitragBasis / prozentSatz), // Speichert den *vollen* Basisbetrag
                manuellBeitrag: parseFloat(jahresbeitragInput.value) || 0, // Speichert den manuellen Wert
                beitragSteigerung: parseFloat(beitragSteigerungInput.value) || 0,
                rendite: rendite,
                einzahlungStartAlter: parseInt(einzahlungStartInput.value, 10) || START_ALTER,
                einzahlungEndAlter: parseInt(einzahlungEndeInput.value, 10) || END_ALTER,
                // NEU: Pausen-Werte auslesen (Default 0)
                pauseStartAlter: parseInt(pauseStartInput.value, 10) || 0,
                pauseEndeAlter: parseInt(pauseEndeInput.value, 10) || 0,
                bezugsAlter: parseInt(bezugAlterSzenarioInput.value, 10) || END_ALTER, 
                // NEUE GEBÜHREN-DATEN
                depotGebuehr: parseFloat(depotGebuehrInput.value) || 0,
                verwaltungsGebuehr: parseFloat(verwaltungsGebuehrInput.value) || 0,
                brokerCourtage: parseFloat(brokerCourtageInput.value) || 0,
                // Display-Texte für Legenden/Tags
                beitragText: beitragText,
                renditeText: displayText
            };
        }

        /**
         * Lädt ein Szenario zum Bearbeiten ins Formular
         */
        function loadScenarioIntoForm(index) {
            const scenario = scenarios[index];
            if (!scenario) return;

            formTitle.textContent = "Szenario Bearbeiten";
            submitButton.textContent = "Szenario Aktualisieren";
            cancelEditButton.style.display = 'block';
            editIndexInput.value = index;

            scenarioNameInput.value = scenario.name;
            anlageTypInput.value = scenario.anlageTyp;
            beitragTypSelect.value = scenario.beitragTyp;
            prozentBeitragInput.value = scenario.prozentBeitrag;
            jahresbeitragInput.value = scenario.manuellBeitrag; // Setzt den gespeicherten manuellen Wert
            beitragSteigerungInput.value = scenario.beitragSteigerung;
            renditeInput.value = scenario.rendite;
            einzahlungStartInput.value = scenario.einzahlungStartAlter;
            einzahlungEndeInput.value = scenario.einzahlungEndAlter;
            // NEU: Pausen-Werte laden
            pauseStartInput.value = scenario.pauseStartAlter || 0;
            pauseEndeInput.value = scenario.pauseEndeAlter || 0;
            bezugAlterSzenarioInput.value = scenario.bezugsAlter; 

            // NEUE GEBÜHREN-FELDER LADEN
            depotGebuehrInput.value = scenario.depotGebuehr;
            verwaltungsGebuehrInput.value = scenario.verwaltungsGebuehr;
            brokerCourtageInput.value = scenario.brokerCourtage;

            updateBeitragFelder(); // Felder (manuell/prozent) korrekt anzeigen
            window.scrollTo(0, 0); // Nach oben scrollen zum Formular
            scenarioNameInput.focus();
        }

        /**
         * Setzt das Formular in den "Neues Szenario"-Zustand zurück
         */
        function resetForm() {
            formTitle.textContent = "Neues Szenario Hinzufügen";
            submitButton.textContent = "Szenario Hinzufügen";
            cancelEditButton.style.display = 'none';
            editIndexInput.value = "-1";
            
            scenarioForm.reset(); // Setzt alle Felder auf Standardwerte (gemäss HTML 'selected')
            
            // --- ÄNDERUNG HIER ---
            // Setzt den Standardwert explizit auf "max-mit-pk"
            beitragTypSelect.value = 'max-mit-pk';
            // --- ENDE ÄNDERUNG ---

            // Setzt den automatischen Namen für das *nächste* Szenario
            scenarioNameInput.value = `Szenario ${scenarioCounter}`;
            // Standardwerte explizit setzen
            prozentBeitragInput.value = '100';
            jahresbeitragInput.value = '6000';
            beitragSteigerungInput.value = '0';
            renditeInput.value = '5';
            einzahlungStartInput.value = START_ALTER;
            einzahlungEndeInput.value = END_ALTER;
            // NEU: Pausen-Felder zurücksetzen
            pauseStartInput.value = '0';
            pauseEndeInput.value = '0';
            bezugAlterSzenarioInput.value = END_ALTER; 
            // NEUE GEBÜHREN-FELDER ZURÜCKSETZEN
            depotGebuehrInput.value = '0';
            verwaltungsGebuehrInput.value = '0';
            brokerCourtageInput.value = '0';

            updateBeitragFelder(); // Felder korrekt anzeigen (WICHTIG: NACH der Wert-Änderung)
            scenarioNameInput.focus();
        }

        /**
         * Zeigt/verbirgt Felder basierend auf "Beitrags-Typ"
         */
        function updateBeitragFelder() {
            if (beitragTypSelect.value === 'manuell') {
                manuellBeitragContainer.style.display = 'block';
                prozentBeitragContainer.style.display = 'none';
            } else {
                manuellBeitragContainer.style.display = 'none';
                prozentBeitragContainer.style.display = 'block';
            }
        }

        /**
         * Zeigt die Liste der hinzugefügten Szenarien als "Tags" an
         */
        function renderScenarioList() {
            scenarioList.innerHTML = ''; // Liste leeren
            scenarios.forEach((scenario, index) => {
                const color = CHART_COLORS[index % CHART_COLORS.length];
                const tag = document.createElement('div');
                tag.className = 'flex items-center space-x-2 rounded-full pl-3 pr-1 py-1 text-sm font-medium';
                tag.style.backgroundColor = color + '20'; // Transparente Hintergrundfarbe
                tag.style.color = color;
                
                const bezugText = (scenario.bezugsAlter < END_ALTER) ? `, Bezug Alter ${scenario.bezugsAlter}` : '';
                
                // NEU: Pausen-Text
                let pausenText = '';
                if (scenario.pauseStartAlter > 0 && scenario.pauseEndeAlter > scenario.pauseStartAlter) {
                    pausenText = ` (Pause ${scenario.pauseStartAlter}-${scenario.pauseEndeAlter})`;
                }
                
                // NEU: Gebühren-Text hinzufügen
                const totalAssetFees = scenario.depotGebuehr + scenario.verwaltungsGebuehr;
                let feeText = '';
                if (totalAssetFees > 0 || scenario.brokerCourtage > 0) {
                    feeText = `, Gebühren: ${totalAssetFees.toFixed(2)}% p.a.`;
                    if (scenario.brokerCourtage > 0) {
                        feeText += ` + ${scenario.brokerCourtage.toFixed(2)}% Einz.`;
                    }
                }

                tag.innerHTML = `
                    <span>
                        <strong>${scenario.name}:</strong> ${scenario.beitragText}, ${scenario.renditeText} (Einz. ${scenario.einzahlungStartAlter}-${scenario.einzahlungEndAlter}${pausenText}${bezugText}${feeText})
                    </span>
                    
                    <!-- Edit Button --><button 
                        data-action="edit" 
                        data-index="${index}"
                        class="p-1 rounded-full opacity-60 hover:opacity-100 hover:bg-white/10"
                        title="Szenario bearbeiten"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                    </button>
                    
                    <!-- Remove Button --><button 
                        data-action="remove" 
                        data-index="${index}"
                        class="p-1 rounded-full opacity-60 hover:opacity-100 hover:bg-white/10"
                        title="Szenario entfernen"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                `;
                scenarioList.appendChild(tag);
            });
        }
        
        /**
         * Ruft die Neuberechnung von Grafik und Tabelle auf
         */
        function updateChartAndTable() {
            // Globale Inflationswerte holen
            const inflationsRate = (parseFloat(inflationInput.value) || 0) / 100;
            const bereinigt = inflationBereinigtCheckbox.checked;

            summaryTitle.textContent = `Zusammenfassung (End-Alter 65)${bereinigt ? ' - Inflationsbereinigt' : ''}`;

            let datasets = [];
            let summaryData = [];
            let allProjections = []; // Speichert die Verläufe für die Schnittpunkt-Berechnung

            scenarios.forEach((scenario, index) => {
                // Inflationswerte an Berechnung übergeben
                const projection = calculateProjection(scenario, inflationsRate, bereinigt);
                allProjections.push(projection); // Für Schnittpunkte speichern
                const color = CHART_COLORS[index % CHART_COLORS.length];
                
                // 1. Datensatz für das Gesamtkapital
                datasets.push({
                    label: `${scenario.name} (${scenario.renditeText})`,
                    data: projection.kapitalVerlauf.map((val, idx) => ({ x: idx, y: val })),
                    borderColor: color,
                    backgroundColor: color + '33', 
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    borderWidth: 2,
                });
                
                // 2. Datensatz für die reinen Einzahlungen (gestrichelt)
                datasets.push({
                    label: `Einzahlungen (${scenario.name})`,
                    data: projection.einzahlungsVerlauf.map((val, idx) => ({ x: idx, y: val })),
                    borderColor: color,
                    backgroundColor: 'transparent',
                    fill: false,
                    borderDash: [5, 5], 
                    pointRadius: 0,
                    borderWidth: 1,
                });
                
                // Daten für die Tabelle sammeln (Werte bei Alter 65)
                summaryData.push({
                    name: scenario.name,
                    color: color, 
                    // KORREKTUR: Der letzte Wert im Array ist Index 47 (Alter 65)
                    endkapital: projection.kapitalVerlauf[GESAMT_JAHRE], 
                    einzahlungen: projection.einzahlungsVerlauf[GESAMT_JAHRE], 
                });
            });

            // --- Schnittpunkt-Berechnung ---
            let intersectionData = [];
            for (let i = 0; i < allProjections.length; i++) {
                for (let j = i + 1; j < allProjections.length; j++) {
                    const dataA = allProjections[i].kapitalVerlauf;
                    const dataB = allProjections[j].kapitalVerlauf;
                    
                    // Sicherstellen, dass die Arrays lang genug sind
                    if (dataA.length < 2 || dataB.length < 2) continue;

                    for (let k = 1; k < dataA.length; k++) {
                        const prevA = dataA[k - 1];
                        const prevB = dataB[k - 1];
                        const currA = dataA[k];
                        const currB = dataB[k];
                        
                        // Prüfen, ob Werte definiert sind (wichtig wegen 'break' im Bezugsalter)
                        if (typeof prevA === 'undefined' || typeof prevB === 'undefined' || 
                            typeof currA === 'undefined' || typeof currB === 'undefined') {
                            continue;
                        }

                        const denom = (currA - prevA) - (currB - prevB);
                        if (denom === 0) continue; 

                        if ((prevA < prevB && currA > currB) || (prevA > prevB && currA < prevB)) {
                            const x_index = (k - 1) + (prevB - prevA) / denom;
                            
                            if (x_index > k - 1 && x_index < k) {
                                const m_A = currA - prevA;
                                const y_val = m_A * (x_index - (k - 1)) + prevA;
                                
                                intersectionData.push({
                                    x: x_index, // x-Wert (z.B. 12.5)
                                    y: y_val  // y-Wert (Kapital)
                                });
                            }
                        }
                    }
                }
            }

            // Schnittpunkt-Datensatz hinzufügen
            datasets.push({
                label: 'Schnittpunkte',
                data: intersectionData,
                backgroundColor: '#fbbf24', // Gelb
                pointStyle: 'crossRot', // 'X' als Punkt-Stil
                radius: 6,
                hoverRadius: 10,
                showLine: false, // Keine Linie, nur Punkte
            });
            // --- Ende Schnittpunkt-Berechnung ---


            renderChart(datasets); 
            renderSummaryTable(summaryData);
        }

        /**
         * Aktualisiert die Chart.js-Grafik
         */
        function renderChart(datasets) { 
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(chartCanvas, {
                type: 'line', 
                data: {
                    datasets: datasets,
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#d1d5db', 
                                filter: function(legendItem, chartData) {
                                    const text = legendItem.text;
                                    return !text.startsWith('Einzahlungen') && !text.startsWith('Schnittpunkte');
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    if (tooltipItems.length > 0) {
                                        if (tooltipItems[0].dataset.label === 'Schnittpunkte') {
                                            return ''; 
                                        }
                                        const xIndex = Math.floor(tooltipItems[0].parsed.x);
                                        return 'Alter ' + (START_ALTER + xIndex);
                                    }
                                    return '';
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    
                                    if (label.startsWith('Schnittpunkte')) {
                                        const xVal = context.parsed.x;
                                        const yVal = context.parsed.y;
                                        const alter = (START_ALTER + xVal).toFixed(1);
                                        const chf = new Intl.NumberFormat('de-CH', {
                                            style: 'currency',
                                            currency: 'CHF',
                                            minimumFractionDigits: 0,
                                            maximumFractionDigits: 0,
                                        }).format(yVal);
                                        
                                        return `Schnittpunkt bei Alter ${alter} (${chf})`;
                                    }
                                    
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('de-CH', {
                                            style: 'currency',
                                            currency: 'CHF',
                                            minimumFractionDigits: 0,
                                            maximumFractionDigits: 0,
                                        }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        },
                    },
                    scales: {
                        x: {
                            type: 'linear', 
                            position: 'bottom',
                            min: 0, // Index 0 (Alter 18)
                            max: GESAMT_JAHRE, // Index 47 (Alter 65)
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value, index, values) {
                                    if (Math.floor(value) === value) {
                                        return 'Alter ' + (START_ALTER + value);
                                    }
                                },
                                stepSize: 5, 
                                includeBounds: true
                            },
                            grid: {
                                color: '#4b5563',
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9ca3af', 
                                callback: function(value, index, values) {
                                    return new Intl.NumberFormat('de-CH', {
                                        style: 'currency',
                                        currency: 'CHF',
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 0,
                                        notation: 'compact' 
                                    }).format(value);
                                }
                            },
                            grid: {
                                color: '#4b5563', 
                            }
                        }
                    }
                }
            });
        }
        
        /**
         * Rendert die Zusammenfassungstabelle
         */
        function renderSummaryTable(summaryData) {
            summaryTableBody.innerHTML = ''; // Tabelle leeren

            const maxEndkapital = Math.max(0, ...summaryData.map(d => d.endkapital));

            const chfFormat = (val) => new Intl.NumberFormat('de-CH', {
                style: 'currency',
                currency: 'CHF',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(val);

            summaryData.forEach(data => {
                const gewinn = data.endkapital - data.einzahlungen;
                const differenz = data.endkapital - maxEndkapital;
                
                // NEU: Faktor berechnen
                let faktorText = '---';
                if (data.einzahlungen > 0) {
                    const faktor = data.endkapital / data.einzahlungen;
                    faktorText = `${faktor.toFixed(1)}x`; // z.B. "2.5x"
                }

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-700';
                
                tr.innerHTML = `
                    <td class="py-3 px-4 text-sm font-medium" style="color: ${data.color};"><strong>${data.name}</strong></td>
                    <td class="py-3 px-4 text-sm text-gray-300 font-bold">${chfFormat(data.endkapital)}</td>
                    <td class="py-3 px-4 text-sm text-gray-400">${chfFormat(data.einzahlungen)}</td>
                    <td class="py-3 px-4 text-sm text-green-400">${chfFormat(gewinn)}</td>
                    <!-- NEU: Faktor Zelle -->
                    <td class="py-3 px-4 text-sm text-gray-300">${faktorText}</td>
                    <td class="py-3 px-4 text-sm text-red-400">
                        ${differenz < 0 ? `${chfFormat(differenz)}` : '---'}
                    </td>
                `;
                summaryTableBody.appendChild(tr);
            });
        }


        /**
         * KORRIGIERTE BERECHNUNG: Einzahlung erfolgt zu Beginn des Jahres.
         * Berechnet die Kapitalentwicklung für ein einzelnes Szenario
         * Berücksichtigt Inflation UND NEUE GEBÜHREN
         */
        function calculateProjection(scenario, inflationsRate, bereinigt) {
            let kapitalVerlauf = [];
            let einzahlungsVerlauf = [];
            
            let aktuellerWert = 0;
            let summeEinzahlungen = 0;
            
            // --- GEBÜHREN & RENDITE BERECHNUNG ---
            const nominaleRendite = scenario.rendite / 100;
            const depotGebuehr = scenario.depotGebuehr / 100;
            const verwaltungsGebuehr = scenario.verwaltungsGebuehr / 100;
            const courtageSatz = scenario.brokerCourtage / 100;
            
            // Jährliche Gebühren werden von der Rendite abgezogen
            const nettoNominaleRenditeFaktor = 1 + nominaleRendite - depotGebuehr - verwaltungsGebuehr;
            
            const inflationsFaktor = 1 + inflationsRate;
            // Renditefaktor ist entweder nominal (netto) oder real (netto)
            const renditeFaktor = bereinigt ? (nettoNominaleRenditeFaktor / inflationsFaktor) : nettoNominaleRenditeFaktor;
            
            const steigerungsFaktor = 1 + scenario.beitragSteigerung / 100;

            // Basis-Jahresbeitrag (nominal)
            let aktuellerJahresbeitrag = 0;
            if (scenario.beitragTyp === 'manuell') {
                aktuellerJahresbeitrag = scenario.manuellBeitrag;
            } else {
                aktuellerJahresbeitrag = scenario.jahresbeitragBasis * (scenario.prozentBeitrag / 100);
            }

            // Der Loop läuft von Alter 18 bis 65 (GESAMT_JAHRE + 1 Iterationen)
            // i=0 (Alter 18), i=1 (Alter 19), ..., i=47 (Alter 65)
            for (let i = 0; i <= GESAMT_JAHRE; i++) {
                
                let aktuellesAlter = START_ALTER + i; // Alter 18, 19, ..., 65
                let einzahlungDiesesJahr = 0; // Nominale Einzahlung

                // 1. Prüfen, ob in diesem Jahr (zu Beginn) eingezahlt wird
                let istInPause = false;
                if (scenario.pauseStartAlter > 0 && scenario.pauseEndeAlter > scenario.pauseStartAlter) {
                    if (aktuellesAlter >= scenario.pauseStartAlter && aktuellesAlter < scenario.pauseEndeAlter) {
                        istInPause = true;
                    }
                }

                // Einzahlung erfolgt *vor* dem Bezugsalter und *vor* dem End-Alter (65)
                if (aktuellesAlter >= scenario.einzahlungStartAlter && 
                    aktuellesAlter < scenario.einzahlungEndAlter && 
                    aktuellesAlter < scenario.bezugsAlter && // Nicht einzahlen im Bezugsjahr
                    !istInPause) {
                    
                    // Steigerung anwenden (erst *nach* dem ersten Einzahlungsjahr)
                    if (aktuellesAlter > scenario.einzahlungStartAlter) {
                        aktuellerJahresbeitrag *= steigerungsFaktor;
                    }
                    einzahlungDiesesJahr = aktuellerJahresbeitrag;
                }
                
                // 2. Einzahlung inflationsbereinigen (auf *heutigen* Wert abzinsen)
                let realeEinzahlung = einzahlungDiesesJahr;
                if (bereinigt) {
                    // i=0 (Alter 18) -> inflationsFaktor^0 = 1 (keine Abzinsung für erste Einzahlung)
                    // i=1 (Alter 19) -> inflationsFaktor^1
                    realeEinzahlung = einzahlungDiesesJahr / Math.pow(inflationsFaktor, i);
                }
                
                // 3. Broker-Courtage von der Einzahlung abziehen
                const nettoEinzahlung = realeEinzahlung * (1 - courtageSatz);
                
                // 4. Einzahlung zum Kapital und zur Summe HINZUFÜGEN (Anfang des Jahres)
                aktuellerWert += nettoEinzahlung;
                summeEinzahlungen += realeEinzahlung; // Summe *vor* Courtage (was der Einzahler leistet)
                
                // 5. Den Wert *zu Beginn* dieses Alters (NACH Einzahlung) speichern
                kapitalVerlauf.push(aktuellerWert);
                einzahlungsVerlauf.push(summeEinzahlungen);

                // 6. Prüfen, ob das Bezugs-Alter (oder Endalter 65) erreicht ist.
                // Wenn ja, werden für dieses Jahr keine Zinsen mehr berechnet.
                if (aktuellesAlter >= scenario.bezugsAlter || aktuellesAlter >= END_ALTER) {
                    // Den Rest des Arrays auffüllen, falls der Bezug vor 65 stattfindet
                    while (kapitalVerlauf.length <= GESAMT_JAHRE) {
                        kapitalVerlauf.push(aktuellerWert);
                        einzahlungsVerlauf.push(summeEinzahlungen);
                    }
                    break; // Berechnung für dieses Szenario beenden
                }
                
                // 7. Zinsen für das *gesamte Jahr* berechnen und für das *nächste* Jahr vorbereiten
                aktuellerWert *= renditeFaktor;
            }
            
            return { kapitalVerlauf, einzahlungsVerlauf };
        }


        // --- CSV Export Funktion (ANGEPASST MIT GEBÜHREN UND PAUSE) ---
        function exportToCSV() {
            if (scenarios.length === 0) {
                console.log("Keine Szenarien zum Exportieren vorhanden.");
                return;
            }

            // Aktuelle Inflations-Einstellungen holen
            const inflationsRate = (parseFloat(inflationInput.value) || 0);
            const bereinigt = inflationBereinigtCheckbox.checked;

            // Alle Projektionen mit den aktuellen Einstellungen berechnen
            const allProjections = scenarios.map(s => calculateProjection(s, inflationsRate / 100, bereinigt));

            let csvContent = "data:text/csv;charset=utf-8,";
            
            // --- Parameter-Block ---
            csvContent += "SZENARIO-PARAMETER" + ";\r\n";
            
            // Globale Parameter
            csvContent += `Inflationsbereinigt;${bereinigt ? 'Ja' : 'Nein'}` + ";\r\n";
            csvContent += `Inflationsrate (%);${inflationsRate.toFixed(2)}` + ";\r\n";
            csvContent += ";\r\n"; // Leerzeile
            
            // Szenario-spezifische Parameter
            let headerReihe1 = ["Parameter"];
            let headerReihe2 = ["Anlage-Typ"];
            let headerReihe3 = ["Beitragstyp"];
            let headerReihe4 = ["Jahresbeitrag (Basis)"];
            let headerReihe5 = ["Beitrag-Steigerung (%)"];
            let headerReihe6 = ["Rendite (%)"];
            let headerReihe7 = ["Depotgebuehr (% p.a.)"];
            let headerReihe8 = ["Verwaltungsgebuehr (% p.a.)"];
            let headerReihe9 = ["Broker-Courtage (% d. Einz.)"];
            let headerReihe10 = ["Einzahlung Start-Alter"];
            let headerReihe11 = ["Einzahlung End-Alter"];
            // NEU: Pausen-Reihen
            let headerReihe12 = ["Pause Start-Alter"];
            let headerReihe13 = ["Pause End-Alter"];
            let headerReihe14 = ["Bezugs-Alter (Stopp)"];

            scenarios.forEach(s => {
                const name = s.name.replace(/;/g, ''); // Semikolons im Namen entfernen
                headerReihe1.push(name);
                headerReihe2.push(s.anlageTyp);
                
                let beitragTypText = s.beitragTyp;
                if(s.beitragTyp !== 'manuell') {
                    beitragTypText += ` (${s.prozentBeitrag.toFixed(0)}%)`;
                }
                headerReihe3.push(beitragTypText);
                
                let basis = (s.beitragTyp === 'manuell') ? s.manuellBeitrag : s.jahresbeitragBasis * (s.prozentBeitrag / 100);
                headerReihe4.push(basis.toFixed(2));
                headerReihe5.push(s.beitragSteigerung.toFixed(2));
                headerReihe6.push(s.rendite.toFixed(2));
                headerReihe7.push(s.depotGebuehr.toFixed(2));
                headerReihe8.push(s.verwaltungsGebuehr.toFixed(2));
                headerReihe9.push(s.brokerCourtage.toFixed(2));
                headerReihe10.push(s.einzahlungStartAlter);
                headerReihe11.push(s.einzahlungEndAlter);
                // NEU: Pausen-Werte
                headerReihe12.push(s.pauseStartAlter || 0);
                headerReihe13.push(s.pauseEndeAlter || 0);
                headerReihe14.push(s.bezugsAlter);
            });

            csvContent += headerReihe1.join(";") + "\r\n";
            csvContent += headerReihe2.join(";") + "\r\n";
            csvContent += headerReihe3.join(";") + "\r\n";
            csvContent += headerReihe4.join(";") + "\r\n";
            csvContent += headerReihe5.join(";") + "\r\n";
            csvContent += headerReihe6.join(";") + "\r\n";
            csvContent += headerReihe7.join(";") + "\r\n"; 
            csvContent += headerReihe8.join(";") + "\r\n"; 
            csvContent += headerReihe9.join(";") + "\r\n"; 
            csvContent += headerReihe10.join(";") + "\r\n";
            csvContent += headerReihe11.join(";") + "\r\n";
            // NEU: Pausen-Reihen
            csvContent += headerReihe12.join(";") + "\r\n"; 
            csvContent += headerReihe13.join(";") + "\r\n"; 
            csvContent += headerReihe14.join(";") + "\r\n";

            csvContent += ";\r\n"; // Leerzeile
            // --- Ende Parameter-Block ---


            // --- Daten-Tabelle ---
            csvContent += "JAHRESENTWICKLUNG" + ";\r\n";
            
            // 1. Header-Zeile erstellen
            let header = ["Alter"];
            scenarios.forEach(s => {
                const name = s.name.replace(/;/g, ''); // Semikolons im Namen entfernen
                header.push(`Kapital (${name})`);
                header.push(`Einzahlungen (${name})`);
            });
            // KORREKTUR: Semikolon als Trennzeichen
            csvContent += header.join(";") + "\r\n";

            // 2. Daten-Zeilen (pro Jahr)
            for (let i = 0; i <= GESAMT_JAHRE; i++) { // Von 0 (Alter 18) bis 47 (Alter 65)
                let row = [];
                row.push(START_ALTER + i); // "Alter" Spalte

                // Daten für jedes Szenario hinzufügen
                allProjections.forEach(projection => {
                    // Formatierung für Excel (Punkt als Dezimaltrennzeichen)
                    // Sicherstellen, dass der Wert existiert (falls Bezugsalter < 65)
                    const kapital = projection.kapitalVerlauf[i] ? projection.kapitalVerlauf[i].toFixed(2) : '0.00';
                    const einzahlungen = projection.einzahlungsVerlauf[i] ? projection.einzahlungsVerlauf[i].toFixed(2) : '0.00';
                    row.push(kapital);
                    row.push(einzahlungen);
                });

                // KORREKTUR: Semikolon als Trennzeichen
                csvContent += row.join(";") + "\r\n";
            }

            // 3. Download auslösen
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            
            let filename = "saeule_3a_export";
            if(bereinigt) {
                filename += "_inflationsbereinigt";
            }
            filename += ".csv";
            
            link.setAttribute("download", filename);
            document.body.appendChild(link); // Erforderlich für Firefox
            link.click();
            document.body.removeChild(link);
        }

        // --- Initialisierung ---

        // Beim Laden der Seite das Formular initialisieren und Grafik leeren
        resetForm();
        updateChartAndTable();

    </script>
</body>
</html>
